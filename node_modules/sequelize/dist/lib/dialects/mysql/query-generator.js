"use strict";var h=Object.defineProperty,m=Object.defineProperties;var M=Object.getOwnPropertyDescriptors;var C=Object.getOwnPropertySymbols;var $=Object.prototype.hasOwnProperty,y=Object.prototype.propertyIsEnumerable;var O=(c,e,t)=>e in c?h(c,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):c[e]=t,T=(c,e)=>{for(var t in e||(e={}))$.call(e,t)&&O(c,t,e[t]);if(C)for(var t of C(e))y.call(e,t)&&O(c,t,e[t]);return c},L=(c,e)=>m(c,M(e));var f=(c,e)=>h(c,"name",{value:e,configurable:!0});const S=require("lodash"),s=require("../../utils"),F=require("../abstract/query-generator"),p=require("util"),_=require("../../operators"),g=/^\s*((?:[a-z]+_){0,2}jsonb?(?:_[a-z]+){0,2})\([^)]*\)/i,D=/^\s*(->>?|@>|<@|\?[|&]?|\|{2}|#-)/i,q=/^\s*((?:([`"'])(?:(?!\2).|\2{2})*\2)|[\w\d\s]+|[().,;+-])/i,d=["CONSTRAINT_NAME as constraint_name","CONSTRAINT_NAME as constraintName","CONSTRAINT_SCHEMA as constraintSchema","CONSTRAINT_SCHEMA as constraintCatalog","TABLE_NAME as tableName","TABLE_SCHEMA as tableSchema","TABLE_SCHEMA as tableCatalog","COLUMN_NAME as columnName","REFERENCED_TABLE_SCHEMA as referencedTableSchema","REFERENCED_TABLE_SCHEMA as referencedTableCatalog","REFERENCED_TABLE_NAME as referencedTableName","REFERENCED_COLUMN_NAME as referencedColumnName"].join(","),Q=new Set(["BLOB","TEXT","GEOMETRY","JSON"]);class I extends F{constructor(e){super(e);this.OperatorMap=L(T({},this.OperatorMap),{[_.regexp]:"REGEXP",[_.notRegexp]:"NOT REGEXP"})}createDatabaseQuery(e,t){return t=T({charset:null,collate:null},t),s.joinSQLFragments(["CREATE DATABASE IF NOT EXISTS",this.quoteIdentifier(e),t.charset&&`DEFAULT CHARACTER SET ${this.escape(t.charset)}`,t.collate&&`DEFAULT COLLATE ${this.escape(t.collate)}`,";"])}dropDatabaseQuery(e){return`DROP DATABASE IF EXISTS ${this.quoteIdentifier(e)};`}createSchema(){return"SHOW TABLES"}showSchemasQuery(){return"SHOW TABLES"}versionQuery(){return"SELECT VERSION() as `version`"}createTableQuery(e,t,n){n=T({engine:"InnoDB",charset:null,rowFormat:null},n);const r=[],i={},a=[];for(const E in t){if(!Object.prototype.hasOwnProperty.call(t,E))continue;const o=t[E];let A;o.includes("PRIMARY KEY")?(r.push(E),o.includes("REFERENCES")?(A=o.match(/^(.+) (REFERENCES.*)$/),a.push(`${this.quoteIdentifier(E)} ${A[1].replace("PRIMARY KEY","")}`),i[E]=A[2]):a.push(`${this.quoteIdentifier(E)} ${o.replace("PRIMARY KEY","")}`)):o.includes("REFERENCES")?(A=o.match(/^(.+) (REFERENCES.*)$/),a.push(`${this.quoteIdentifier(E)} ${A[1]}`),i[E]=A[2]):a.push(`${this.quoteIdentifier(E)} ${o}`)}const l=this.quoteTable(e);let u=a.join(", ");const N=r.map(E=>this.quoteIdentifier(E)).join(", ");n.uniqueKeys&&S.each(n.uniqueKeys,(E,o)=>{E.customIndex&&(typeof o!="string"&&(o=`uniq_${e}_${E.fields.join("_")}`),u+=`, UNIQUE ${this.quoteIdentifier(o)} (${E.fields.map(A=>this.quoteIdentifier(A)).join(", ")})`)}),N.length>0&&(u+=`, PRIMARY KEY (${N})`);for(const E in i)Object.prototype.hasOwnProperty.call(i,E)&&(u+=`, FOREIGN KEY (${this.quoteIdentifier(E)}) ${i[E]}`);return s.joinSQLFragments(["CREATE TABLE IF NOT EXISTS",l,`(${u})`,`ENGINE=${n.engine}`,n.comment&&typeof n.comment=="string"&&`COMMENT ${this.escape(n.comment)}`,n.charset&&`DEFAULT CHARSET=${n.charset}`,n.collate&&`COLLATE ${n.collate}`,n.initialAutoIncrement&&`AUTO_INCREMENT=${n.initialAutoIncrement}`,n.rowFormat&&`ROW_FORMAT=${n.rowFormat}`,";"])}describeTableQuery(e,t,n){return`SHOW FULL COLUMNS FROM ${this.quoteTable(this.addSchema({tableName:e,_schema:t,_schemaDelimiter:n}))};`}showTablesQuery(e){let t="SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE'";return e?t+=` AND TABLE_SCHEMA = ${this.escape(e)}`:t+=" AND TABLE_SCHEMA NOT IN ('MYSQL', 'INFORMATION_SCHEMA', 'PERFORMANCE_SCHEMA', 'SYS')",`${t};`}addColumnQuery(e,t,n){return s.joinSQLFragments(["ALTER TABLE",this.quoteTable(e),"ADD",this.quoteIdentifier(t),this.attributeToSQL(n,{context:"addColumn",tableName:e,foreignKey:t}),";"])}removeColumnQuery(e,t){return s.joinSQLFragments(["ALTER TABLE",this.quoteTable(e),"DROP",this.quoteIdentifier(t),";"])}changeColumnQuery(e,t){const n=[],r=[];for(const i in t){let a=t[i];if(a.includes("REFERENCES")){const l=this.quoteIdentifier(i);a=a.replace(/.+?(?=REFERENCES)/,""),r.push(`FOREIGN KEY (${l}) ${a}`)}else n.push(`\`${i}\` \`${i}\` ${a}`)}return s.joinSQLFragments(["ALTER TABLE",this.quoteTable(e),n.length&&`CHANGE ${n.join(", ")}`,r.length&&`ADD ${r.join(", ")}`,";"])}renameColumnQuery(e,t,n){const r=[];for(const i in n){const a=n[i];r.push(`\`${t}\` \`${i}\` ${a}`)}return s.joinSQLFragments(["ALTER TABLE",this.quoteTable(e),"CHANGE",r.join(", "),";"])}handleSequelizeMethod(e,t,n,r,i){if(e instanceof s.Json){if(e.conditions)return this.parseConditionObject(e.conditions).map(l=>`${this.jsonPathExtractionQuery(l.path[0],S.tail(l.path))} = '${l.value}'`).join(" AND ");if(e.path){let a;if(this._checkValidJsonStatement(e.path))a=e.path;else{const l=S.toPath(e.path),u=l.shift();a=this.jsonPathExtractionQuery(u,l)}return e.value&&(a+=p.format(" = %s",this.escape(e.value))),a}}else e instanceof s.Cast&&(/timestamp/i.test(e.type)?e.type="datetime":e.json&&/boolean/i.test(e.type)?e.type="char":/double precision/i.test(e.type)||/boolean/i.test(e.type)||/integer/i.test(e.type)?e.type="decimal":/text/i.test(e.type)&&(e.type="char"));return super.handleSequelizeMethod(e,t,n,r,i)}_toJSONValue(e){return typeof e=="boolean"?e.toString():e===null?"null":e}truncateTableQuery(e){return`TRUNCATE ${this.quoteTable(e)}`}deleteQuery(e,t,n={},r){let i="",a=`DELETE FROM ${this.quoteTable(e)}`;return n.limit&&(i=` LIMIT ${this.escape(n.limit)}`),t=this.getWhereConditions(t,null,r,n),t&&(a+=` WHERE ${t}`),a+i}showIndexesQuery(e,t){return s.joinSQLFragments([`SHOW INDEX FROM ${this.quoteTable(e)}`,t&&t.database&&`FROM \`${t.database}\``])}showConstraintsQuery(e,t){const n=e.tableName||e,r=e.schema;return s.joinSQLFragments(["SELECT CONSTRAINT_CATALOG AS constraintCatalog,","CONSTRAINT_NAME AS constraintName,","CONSTRAINT_SCHEMA AS constraintSchema,","CONSTRAINT_TYPE AS constraintType,","TABLE_NAME AS tableName,","TABLE_SCHEMA AS tableSchema","from INFORMATION_SCHEMA.TABLE_CONSTRAINTS",`WHERE table_name='${n}'`,t&&`AND constraint_name = '${t}'`,r&&`AND TABLE_SCHEMA = '${r}'`,";"])}removeIndexQuery(e,t){let n=t;return typeof n!="string"&&(n=s.underscore(`${e}_${t.join("_")}`)),s.joinSQLFragments(["DROP INDEX",this.quoteIdentifier(n),"ON",this.quoteTable(e)])}attributeToSQL(e,t){S.isPlainObject(e)||(e={type:e});const n=e.type.toString({escape:this.escape.bind(this)});let r=n;if(e.allowNull===!1&&(r+=" NOT NULL"),e.autoIncrement&&(r+=" auto_increment"),!Q.has(n)&&e.type._binary!==!0&&s.defaultValueSchemable(e.defaultValue)&&(r+=` DEFAULT ${this.escape(e.defaultValue)}`),e.unique===!0&&(r+=" UNIQUE"),e.primaryKey&&(r+=" PRIMARY KEY"),e.comment&&(r+=` COMMENT ${this.escape(e.comment)}`),e.first&&(r+=" FIRST"),e.after&&(r+=` AFTER ${this.quoteIdentifier(e.after)}`),e.references){if(t&&t.context==="addColumn"&&t.foreignKey){const i=this.quoteIdentifier(t.foreignKey);r+=`, ADD CONSTRAINT ${this.quoteIdentifier(`${t.tableName}_${i}_foreign_idx`)} FOREIGN KEY (${i})`}r+=` REFERENCES ${this.quoteTable(e.references.model)}`,e.references.key?r+=` (${this.quoteIdentifier(e.references.key)})`:r+=` (${this.quoteIdentifier("id")})`,e.onDelete&&(r+=` ON DELETE ${e.onDelete.toUpperCase()}`),e.onUpdate&&(r+=` ON UPDATE ${e.onUpdate.toUpperCase()}`)}return r}attributesToSQL(e,t){const n={};for(const r in e){const i=e[r];n[i.field||r]=this.attributeToSQL(i,t)}return n}_checkValidJsonStatement(e){if(typeof e!="string")return!1;let t=0,n=0,r=0,i=!1,a=!1;for(;t<e.length;){const l=e.substr(t),u=g.exec(l);if(u){t+=u[0].indexOf("("),i=!0;continue}const N=D.exec(l);if(N){t+=N[0].length,i=!0;continue}const E=q.exec(l);if(E){const o=E[1];if(o==="(")n++;else if(o===")")r++;else if(o===";"){a=!0;break}t+=E[0].length;continue}break}if(i&&(a||n!==r))throw new Error(`Invalid json statement: ${e}`);return i}getForeignKeysQuery(e,t){const n=e.tableName||e;return s.joinSQLFragments(["SELECT",d,`FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE where TABLE_NAME = '${n}'`,`AND CONSTRAINT_NAME!='PRIMARY' AND CONSTRAINT_SCHEMA='${t}'`,"AND REFERENCED_TABLE_NAME IS NOT NULL",";"])}getForeignKeyQuery(e,t){const n=e.schema?R(e.schema):"",r=R(e.tableName||e),i=R(t);return s.joinSQLFragments(["SELECT",d,"FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE","WHERE (",[`REFERENCED_TABLE_NAME = ${r}`,e.schema&&`AND REFERENCED_TABLE_SCHEMA = ${n}`,`AND REFERENCED_COLUMN_NAME = ${i}`],") OR (",[`TABLE_NAME = ${r}`,e.schema&&`AND TABLE_SCHEMA = ${n}`,`AND COLUMN_NAME = ${i}`,"AND REFERENCED_TABLE_NAME IS NOT NULL"],")"])}dropForeignKeyQuery(e,t){return s.joinSQLFragments(["ALTER TABLE",this.quoteTable(e),"DROP FOREIGN KEY",this.quoteIdentifier(t),";"])}}f(I,"MySQLQueryGenerator");function R(c){return s.addTicks(c,"'")}f(R,"wrapSingleQuote"),module.exports=I;
//# sourceMappingURL=query-generator.js.map
