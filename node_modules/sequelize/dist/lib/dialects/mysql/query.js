"use strict";var w=Object.defineProperty;var E=Object.getOwnPropertySymbols;var I=Object.prototype.hasOwnProperty,C=Object.prototype.propertyIsEnumerable;var R=(u,e,t)=>e in u?w(u,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):u[e]=t,_=(u,e)=>{for(var t in e||(e={}))I.call(e,t)&&R(u,t,e[t]);if(E)for(var t of E(e))C.call(e,t)&&R(u,t,e[t]);return u};var m=(u,e)=>w(u,"name",{value:e,configurable:!0});const b=require("../abstract/query"),d=require("../../errors"),p=require("lodash"),{logger:x}=require("../../utils/logger"),K=1062,q=1213,Q=1451,N=1452,S=x.debugContext("sql:mysql");class y extends b{constructor(e,t,n){super(e,t,_({showWarnings:!1},n))}static formatBindParameters(e,t,n){const s=[],r=m((i,o,h)=>{if(h[o]!==void 0)return s.push(h[o]),"?"},"replacementFunc");return e=b.formatBindParameters(e,t,n,r)[0],[e,s.length>0?s:void 0]}async run(e,t){this.sql=e;const{connection:n,options:s}=this,r=this.sequelize.options.showWarnings||s.showWarnings,i=this._logQuery(e,S,t);t&&S("parameters(%j)",t);let o;const h=new Error;try{t&&t.length?o=await new Promise((l,a)=>{n.execute(e,t,(c,f)=>c?a(c):l(f)).setMaxListeners(100)}):o=await new Promise((l,a)=>{n.query({sql:e},(c,f)=>c?a(c):l(f)).setMaxListeners(100)})}catch(l){if(s.transaction&&l.errno===q){try{await s.transaction.rollback()}catch(a){}s.transaction.finished="rollback"}throw l.sql=e,l.parameters=t,this.formatError(l,h.stack)}finally{i()}return r&&o&&o.warningStatus>0&&await this.logWarnings(o),this.formatResults(o)}formatResults(e){let t=this.instance;if(this.isInsertQuery(e)&&(this.handleInsertQuery(e),!this.instance))if(e.constructor.name==="ResultSetHeader"&&this.model&&this.model.autoIncrementAttribute&&this.model.autoIncrementAttribute===this.model.primaryKeyAttribute&&this.model.rawAttributes[this.model.primaryKeyAttribute]){const n=e[this.getInsertIdField()];t=[];for(let s=n;s<n+e.affectedRows;s++)t.push({[this.model.rawAttributes[this.model.primaryKeyAttribute].field]:s})}else t=e[this.getInsertIdField()];if(this.isSelectQuery())return this.handleSelectQuery(e);if(this.isShowTablesQuery())return this.handleShowTablesQuery(e);if(this.isDescribeQuery()){t={};for(const n of e){const s=/^enum/i;t[n.Field]={type:s.test(n.Type)?n.Type.replace(s,"ENUM"):n.Type.toUpperCase(),allowNull:n.Null==="YES",defaultValue:n.Default,primaryKey:n.Key==="PRI",autoIncrement:Object.prototype.hasOwnProperty.call(n,"Extra")&&n.Extra.toLowerCase()==="auto_increment",comment:n.Comment?n.Comment:null}}return t}return this.isShowIndexesQuery()?this.handleShowIndexesQuery(e):this.isCallQuery()?e[0]:this.isBulkUpdateQuery()||this.isBulkDeleteQuery()?e.affectedRows:this.isVersionQuery()?e[0].version:this.isForeignKeysQuery()?e:this.isUpsertQuery()?[t,e.affectedRows===1]:this.isInsertQuery()||this.isUpdateQuery()?[t,e.affectedRows]:this.isShowConstraintsQuery()?e:this.isRawQuery()?[e,e]:t}async logWarnings(e){const t=await this.run("SHOW WARNINGS"),n=`MySQL Warnings (${this.connection.uuid||"default"}): `,s=[];for(const r of t)if(!(r===void 0||typeof r[Symbol.iterator]!="function"))for(const i of r)if(Object.prototype.hasOwnProperty.call(i,"Message"))s.push(i.Message);else for(const o of i.keys())s.push([o,i[o]].join(": "));return this.sequelize.log(n+s.join("; "),this.options),e}formatError(e,t){const n=e.errno||e.code;switch(n){case K:{const s=e.message.match(/Duplicate entry '([\s\S]*)' for key '?((.|\s)*?)'?$/);let r={},i="Validation error";const o=s?s[1].split("-"):void 0,h=s?s[2].split(".").pop():void 0,l=s?s[1]:void 0,a=this.model&&this.model.uniqueKeys[h];a?(a.msg&&(i=a.msg),r=p.zipObject(a.fields,o)):r[h]=l;const c=[];return p.forOwn(r,(f,g)=>{c.push(new d.ValidationErrorItem(this.getUniqueConstraintErrorMessage(g),"unique violation",g,f,this.instance,"not_unique"))}),new d.UniqueConstraintError({message:i,errors:c,parent:e,fields:r,stack:t})}case Q:case N:{const s=e.message.match(/CONSTRAINT ([`"])(.*)\1 FOREIGN KEY \(\1(.*)\1\) REFERENCES \1(.*)\1 \(\1(.*)\1\)/),r=s?s[1]:"`",i=s?s[3].split(new RegExp(`${r}, *${r}`)):void 0;return new d.ForeignKeyConstraintError({reltype:String(n)===String(Q)?"parent":"child",table:s?s[4]:void 0,fields:i,value:i&&i.length&&this.instance&&this.instance[i[0]]||void 0,index:s?s[2]:void 0,parent:e,stack:t})}default:return new d.DatabaseError(e,{stack:t})}}handleShowIndexesQuery(e){return e=e.reduce((t,n)=>(n.Key_name in t||(t[n.Key_name]=n,n.fields=[]),t[n.Key_name].fields[n.Seq_in_index-1]={attribute:n.Column_name,length:n.Sub_part||void 0,order:n.Collation==="A"?"ASC":void 0},delete n.column_name,t),{}),p.map(e,t=>({primary:t.Key_name==="PRIMARY",fields:t.fields,name:t.Key_name,tableName:t.Table,unique:t.Non_unique!==1,type:t.Index_type}))}}m(y,"Query"),module.exports=y,module.exports.Query=y,module.exports.default=y;
//# sourceMappingURL=query.js.map
