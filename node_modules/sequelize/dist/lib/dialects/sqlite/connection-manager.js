"use strict";var h=Object.defineProperty;var o=(t,e)=>h(t,"name",{value:e,configurable:!0});const q=require("fs"),f=require("path"),g=require("../abstract/connection-manager"),{logger:m}=require("../../utils/logger"),a=m.debugContext("connection:sqlite"),y=require("../../data-types").sqlite,E=require("../../errors"),u=require("../parserStore")("sqlite"),{promisify:M}=require("util");class r extends g{constructor(e,s){super(e,s);this.sequelize.options.host==="localhost"&&delete this.sequelize.options.host,this.connections={},this.lib=this._loadDialectModule("sqlite3"),this.refreshTypeParser(y)}async _onProcessExit(){return await Promise.all(Object.getOwnPropertyNames(this.connections).map(e=>M(s=>this.connections[e].close(s))())),super._onProcessExit.call(this)}_refreshTypeParser(e){u.refresh(e)}_clearTypeParser(){u.clear()}async getConnection(e){e=e||{},e.uuid=e.uuid||"default",!!this.sequelize.options.storage!==null&&this.sequelize.options.storage!==void 0?e.storage=this.sequelize.options.storage:e.storage=this.sequelize.options.host||":memory:",e.inMemory=e.storage===":memory:"?1:0;const s=this.sequelize.options.dialectOptions,c=this.lib.OPEN_READWRITE|this.lib.OPEN_CREATE;if(e.readWriteMode=s&&s.mode||c,this.connections[e.inMemory||e.uuid])return this.connections[e.inMemory||e.uuid];!e.inMemory&&(e.readWriteMode&this.lib.OPEN_CREATE)!=0&&q.mkdirSync(f.dirname(e.storage),{recursive:!0});const i=await new Promise((l,d)=>{this.connections[e.inMemory||e.uuid]=new this.lib.Database(e.storage,e.readWriteMode,n=>{if(n)return d(new E.ConnectionError(n));a(`connection acquired ${e.uuid}`),l(this.connections[e.inMemory||e.uuid])})});return this.sequelize.config.password&&i.run(`PRAGMA KEY=${this.sequelize.escape(this.sequelize.config.password)}`),this.sequelize.options.foreignKeys!==!1&&i.run("PRAGMA FOREIGN_KEYS=ON"),i}releaseConnection(e,s){e.filename===":memory:"&&s!==!0||e.uuid&&(e.close(),a(`connection released ${e.uuid}`),delete this.connections[e.uuid])}}o(r,"ConnectionManager"),module.exports=r,module.exports.ConnectionManager=r,module.exports.default=r;
//# sourceMappingURL=connection-manager.js.map
